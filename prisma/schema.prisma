// Baus Optical — Lenses SMS Platform
// Full multi-branch Prisma schema
// Switch provider to "postgresql" and set DATABASE_URL to your Supabase connection string

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// AUTH & USERS
// ─────────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         String   @default("STAFF") // Enum: UserRole
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
  @@index([branchId])
}

// Enum UserRole removed

// ─────────────────────────────────────────────
// BRANCHES (Multi-location support)
// ─────────────────────────────────────────────

model Branch {
  id          String      @id @default(uuid())
  name        String
  location    String
  phone       String?
  timezone    String      @default("Africa/Nairobi")
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  users       User[]
  customers   Customer[]
  campaigns   Campaign[]
  reminders   Reminder[]
  smsLogs     SmsLog[]
  posConfig   PosConfig?

  @@index([isActive])
}

// ─────────────────────────────────────────────
// POS INTEGRATION CONFIG (per branch)
// ─────────────────────────────────────────────

model PosConfig {
  id              String   @id @default(uuid())
  branchId        String   @unique
  branch          Branch   @relation(fields: [branchId], references: [id])

  // API Key method
  posApiKey       String?  // Encrypted API key for pulling data from POS
  posApiBaseUrl   String?  // e.g. https://pos.bausoptical.com/api

  // Webhook method
  webhookSecret   String   // HMAC secret for verifying incoming webhook events
  webhookEnabled  Boolean  @default(true)

  // SMS Provider config (per branch so different branches can use different providers)
  smsProvider     String   @default("AFRICAS_TALKING") // Enum: SmsProvider
  smsApiKey       String?
  smsSenderId     String?     // e.g. "BausOptical"
  smsUsername     String?     // Africa's Talking username

  // Automation settings
  automationEnabled       Boolean @default(true)
  retryFailedSms          Boolean @default(true)
  defaultDelayMinutes     Int     @default(10)
  optOutKeyword           String  @default("STOP")

  lastWebhookReceivedAt   DateTime?
  lastApiPollAt           DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Enum SmsProvider removed

// ─────────────────────────────────────────────
// CUSTOMERS
// ─────────────────────────────────────────────

model Customer {
  id              String    @id @default(uuid())
  branchId        String
  branch          Branch    @relation(fields: [branchId], references: [id])

  // Core fields synced from POS
  posCustomerId   String?   // ID in the external POS system
  name            String
  phone           String
  email           String?
  source          String @default("MANUAL") // Enum: CustomerSource

  // Opt-out management
  optedOut        Boolean   @default(false)
  optedOutAt      DateTime?

  // Tags (e.g. Glasses, Contact Lens, Eye Exam, Repair)
  tags            String    @default("")

  // Reminder tracking
  lastVisitAt     DateTime?
  lastPurchaseAt  DateTime?
  nextReminderAt  DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  reminders       Reminder[]
  smsLogs         SmsLog[]

  @@unique([branchId, phone])           // One customer per phone per branch
  @@unique([branchId, posCustomerId])   // One POS customer per branch
  @@index([branchId])
  @@index([optedOut])
  @@index([nextReminderAt])
}

// Enum CustomerSource removed

// ─────────────────────────────────────────────
// SMS TEMPLATES
// ─────────────────────────────────────────────

model Template {
  id           String        @id @default(uuid())
  name         String
  type         String  @default("AUTOMATIC") // Enum: TemplateType
  category     String @default("GENERAL")   // Enum: TemplateCategory
  triggerEvent String?       // Enum: TriggerEvent
  delayValue   Int?
  delayUnit    String?       // Enum: DelayUnit
  message      String        // Supports {{customer_name}}, {{order_id}}, {{branch_name}}, {{appointment_date}}, {{doctor_name}}
  status       String        @default("ACTIVE") // ACTIVE, PAUSED
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  reminders    Reminder[]
  campaigns    Campaign[]
  smsLogs      SmsLog[]

  @@index([type])
  @@index([status])
  @@index([triggerEvent])
}

// Enum TemplateType removed

// Enum TemplateCategory removed

// Enum TriggerEvent removed

// Enum DelayUnit removed

// ─────────────────────────────────────────────
// POS EVENTS (raw event log from POS)
// ─────────────────────────────────────────────

model PosEvent {
  id            String        @id @default(uuid())
  branchId      String
  source        String   @default("WEBHOOK") // Enum: EventSource

  // Raw event data from POS
  eventType     String        // Maps to TriggerEvent
  posEventId    String?       // POS system's own event ID (for deduplication)
  rawPayload    String        // Full raw payload stored for debugging/replay

  // Extracted fields
  customerPhone String?
  customerName  String?
  orderId       String?
  appointmentDate DateTime?

  // Processing status
  processed     Boolean       @default(false)
  processedAt   DateTime?
  smsTriggered  Boolean       @default(false)
  error         String?

  receivedAt    DateTime      @default(now())

  @@unique([branchId, posEventId]) // Prevent duplicate processing
  @@index([branchId])
  @@index([processed])
  @@index([eventType])
}

// Enum EventSource removed

// ─────────────────────────────────────────────
// REMINDERS (scheduled individual SMS)
// ─────────────────────────────────────────────

model Reminder {
  id           String         @id @default(uuid())
  branchId     String
  branch       Branch         @relation(fields: [branchId], references: [id])
  customerId   String
  customer     Customer       @relation(fields: [customerId], references: [id])
  templateId   String
  template     Template       @relation(fields: [templateId], references: [id])

  type         String         // e.g. "Follow-up", "6 Month Checkup", "Annual Review"
  relatedEvent String?        // e.g. "Purchase (Glasses)", "Eye Exam"
  scheduledAt  DateTime
  sentAt       DateTime?
  status       String @default("PENDING") // Enum: ReminderStatus
  error        String?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([branchId])
  @@index([customerId])
  @@index([scheduledAt])
  @@index([status])
}

// Enum ReminderStatus removed

// ─────────────────────────────────────────────
// CAMPAIGNS (bulk SMS to a group)
// ─────────────────────────────────────────────

model Campaign {
  id              String          @id @default(uuid())
  branchId        String
  branch          Branch          @relation(fields: [branchId], references: [id])
  templateId      String
  template        Template        @relation(fields: [templateId], references: [id])

  name            String
  audienceFilter  String?         // e.g. { tags: ["Glasses"], lastVisitBefore: "2024-01-01" }
  audienceSize    Int             @default(0)
  scheduledAt     DateTime?
  sentAt          DateTime?
  status          String  @default("DRAFT") // Enum: CampaignStatus

  // Stats
  totalSent       Int             @default(0)
  totalDelivered  Int             @default(0)
  totalFailed     Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  smsLogs         SmsLog[]

  @@index([branchId])
  @@index([status])
}

// Enum CampaignStatus removed

// ─────────────────────────────────────────────
// SMS LOG (every message sent)
// ─────────────────────────────────────────────

model SmsLog {
  id           String      @id @default(uuid())
  branchId     String
  branch       Branch      @relation(fields: [branchId], references: [id])
  customerId   String?
  customer     Customer?   @relation(fields: [customerId], references: [id])
  templateId   String?
  template     Template?   @relation(fields: [templateId], references: [id])
  campaignId   String?
  campaign     Campaign?   @relation(fields: [campaignId], references: [id])

  phone        String
  message      String      // Final rendered message (variables replaced)
  provider     String      // Enum: SmsProvider
  providerMsgId String?    // Message ID from SMS provider (for delivery tracking)

  status       String   @default("PENDING") // Enum: SmsStatus
  statusUpdatedAt DateTime?
  errorMessage String?
  retryCount   Int         @default(0)

  sentAt       DateTime    @default(now())

  @@index([branchId])
  @@index([customerId])
  @@index([status])
  @@index([sentAt])
  @@index([providerMsgId])
}

// Enum SmsStatus removed
